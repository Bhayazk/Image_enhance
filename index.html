<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Enhancer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #333;
    }

    .input-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    label {
      font-weight: bold;
      color: #555;
    }

    input[type="file"], select, button {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #218838;
    }

    .image-section {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }

    .image-section div {
      flex: 1;
      text-align: center;
    }

    img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 10px;
    }

    #downloadLink {
      display: block;
      margin-top: 10px;
      color: #007bff;
      text-decoration: none;
    }

    #downloadLink:hover {
      text-decoration: underline;
    }

    #loading {
      display: none;
      text-align: center;
      color: #555;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .image-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Image Enhancer</h1>
    <div class="input-section">
      <label for="imageUpload">Upload Image:</label>
      <input type="file" id="imageUpload" accept="image/*" />
      <label for="enhanceType">Enhancement Type:</label>
      <select id="enhanceType">
        <option value="enhance">Enhance</option>
        <option value="dehaze">Dehaze</option>
        <option value="recolor">Recolor</option>
      </select>
      <button onclick="enhanceImage()">Enhance Image</button>
    </div>
    <div id="loading">Processing...</div>
    <div class="image-section">
      <div>
        <h2>Original Image</h2>
        <img id="originalImage" alt="Original Image" style="display: none;" />
      </div>
      <div>
        <h2>Enhanced Image</h2>
        <img id="enhancedImage" alt="Enhanced Image" style="display: none;" />
        <a id="downloadLink" style="display: none;" download="enhanced_image.jpg">Download Enhanced Image</a>
      </div>
    </div>
    <div id="error" class="error" style="display: none;"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/file-type@16.5.3/dist/file-type.min.js"></script>
  <script>
    // Buffer polyfill for browser environment
    if (typeof Buffer === 'undefined') {
      window.Buffer = {
        from: (data) => {
          if (data instanceof Uint8Array) return data;
          if (Array.isArray(data)) return new Uint8Array(data);
          if (typeof data === 'string') return new Uint8Array([...data].map((c) => c.charCodeAt(0)));
          throw new Error('Unsupported Buffer.from input');
        },
        concat: (buffers) => {
          const totalLength = buffers.reduce((sum, buf) => sum + buf.length, 0);
          const result = new Uint8Array(totalLength);
          let offset = 0;
          for (const buf of buffers) {
            result.set(buf, offset);
            offset += buf.length;
          }
          return result;
        },
      };
    }

    // Function to upload image to ImgBB
    async function uploadImage(file) {
      const form = new FormData();
      form.append('image', file);
      try {
        const response = await axios.post('https://api.imgbb.com/1/upload', form, {
          params: {
            key: 'ece5e2f4462ff6f8be41c9742c3cea0f',
          },
        });
        return response.data.data.url; // ImgBB returns the image URL
      } catch (error) {
        throw new Error(`Image upload to ImgBB failed: ${error.message}`);
      }
    }

    // Function to enhance image
    async function remini(imageUrl, enhancementType = 'enhance') {
      return new Promise((resolve, reject) => {
        const validTypes = ['enhance', 'dehaze', 'recolor'];
        if (!validTypes.includes(enhancementType)) enhancementType = 'enhance';

        // Use CORS proxy to bypass potential CORS issues (temporary)
        const corsProxy = 'https://cors-anywhere.herokuapp.com/';
        const url = `${corsProxy}https://inferenceengine.vyro.ai/${enhancementType}`;
        const data = {
          image_url: imageUrl,
          model_version: '1',
        };

        axios
          .post(url, data, {
            headers: {
              'User-Agent': 'okhttp/4.9.3',
              'Connection': 'Keep-Alive',
              'Accept-Encoding': 'gzip',
              'Content-Type': 'application/json',
            },
            responseType: 'arraybuffer',
          })
          .then((response) => {
            resolve(Buffer.from(response.data));
          })
          .catch((error) => {
            reject(new Error(`API request failed: ${error.message}`));
          });
      });
    }

    // Handle image enhancement
    async function enhanceImage() {
      const imageUpload = document.getElementById('imageUpload');
      const enhanceType = document.getElementById('enhanceType').value;
      const originalImage = document.getElementById('originalImage');
      const enhancedImage = document.getElementById('enhancedImage');
      const downloadLink = document.getElementById('downloadLink');
      const errorDiv = document.getElementById('error');
      const loadingDiv = document.getElementById('loading');

      // Reset UI
      errorDiv.style.display = 'none';
      enhancedImage.style.display = 'none';
      downloadLink.style.display = 'none';
      loadingDiv.style.display = 'none';

      if (!imageUpload.files[0]) {
        errorDiv.textContent = 'Please select an image to upload.';
        errorDiv.style.display = 'block';
        return;
      }

      const file = imageUpload.files[0];
      // Check file size (10MB limit)
      if (file.size > 10 * 1024 * 1024) {
        errorDiv.textContent = 'Image size exceeds 10MB.';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        // Show loading indicator
        loadingDiv.style.display = 'block';

        // Display original image
        originalImage.src = URL.createObjectURL(file);
        originalImage.style.display = 'block';

        // Detect file type
        const { FileType } = window['file-type'];
        const arrayBuffer = await file.arrayBuffer();
        const fileType = await FileType.fromBuffer(arrayBuffer);
        const mimeType = fileType?.mime || 'image/jpeg';
        const ext = fileType?.ext || 'jpg';

        // Upload image to ImgBB
        const imageUrl = await uploadImage(file);

        // Call remini function with image URL
        const enhancedBuffer = await remini(imageUrl, enhanceType);

        // Display enhanced image
        const blob = new Blob([enhancedBuffer], { type: mimeType });
        enhancedImage.src = URL.createObjectURL(blob);
        enhancedImage.style.display = 'block';

        // Set up download link
        downloadLink.href = enhancedImage.src;
        downloadLink.download = `enhanced_image.${ext}`;
        downloadLink.style.display = 'block';
      } catch (error) {
        errorDiv.textContent = `Error: ${error.message}`;
        errorDiv.style.display = 'block';
      } finally {
        loadingDiv.style.display = 'none';
      }
    }
  </script>
</body>
</html>
